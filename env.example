# =========================
# Amber + GoodWe + AlphaESS
# =========================
#
# Notes on pricing sign:
#   feedIn > 0.0c  => you GET PAID to export
#   feedIn < 0.0c  => you PAY to export
#
# The script treats "export would cost money" as:
#   export_costs = (feedIn < EXPORT_COST_THRESHOLD_C)
# Default threshold is 0.0c.

# -------------------------
# Amber API (REQUIRED)
# -------------------------
AMBER_API_KEY=psk_
AMBER_SITE_ID=
EXPORT_COST_THRESHOLD_C=0.0

# How often Amber prices are interval-based (AU often 5 minutes)
AMBER_RESOLUTION_MIN=5

# Optional: also fetch usage (used only for extra logging/telemetry)
AMBER_FETCH_USAGE=1
AMBER_USAGE_RESOLUTION_MIN=5

# If Amber becomes stale/unavailable beyond this, script assumes export MAY be costly (fail-safe)
AMBER_MAX_STALE_SEC=900


# -------------------------
# AlphaESS OpenAPI (recommended)
# -------------------------
ALPHAESS_OPENAPI_ENABLED=1

# From https://open.alphaess.com/
ALPHAESS_APP_ID=alpha
ALPHAESS_APP_SECRET=
#
# ALPHAESS_SYS_SN can be either:
#   - the full sysSn string, OR
#   - a small number (1-based) to select an item from your account list (convenience)
ALPHAESS_SYS_SN=
ALPHAESS_UNIT_INDEX=1

# SSL verify (leave enabled unless debugging cert/proxy issues)
ALPHAESS_VERIFY_SSL=1

# If these signs are reversed in your Alpha data, flip these to 0
# Script normalises internally to:
#   pBat: + = charging, - = discharging
#   pGrid:+ = import,   - = export
ALPHAESS_PBAT_POSITIVE_IS_CHARGE=1
ALPHAESS_PGRID_POSITIVE_IS_IMPORT=1

# Treat |pBat| below this as 'idle' (noise floor)
ALPHAESS_PBAT_IDLE_THRESHOLD_W=50

# Alpha polling behaviour
ALPHAESS_MIN_POLL_INTERVAL_SEC=15
ALPHAESS_POLL_TIMEOUT_SEC=12.0
ALPHAESS_MAX_STALE_SEC=30


# -------------------------
# AlphaESS control tuning (when export_costs=True)
# -------------------------

# Grid feedback gain: how aggressively we adjust PV limit based on pGrid export/import
ALPHAESS_GRID_FEEDBACK_GAIN=1.0

# Bias slightly toward importing (W) to avoid tiny accidental exports
ALPHAESS_GRID_IMPORT_BIAS_W=50

# Consider battery "full" at/above this SOC (%)
# (Default 99.5 so integer 100% counts as full)
ALPHAESS_FULL_SOC_PCT=99.5

# When export would cost money AND battery is NOT full:
# allow up to this much export before backing GoodWe off
ALPHAESS_EXPORT_ALLOW_W_BELOW_FULL_SOC=50

# Optional "auto charge headroom" behaviour (when export_costs=True and battery is full/unknown SOC):
# If SOC is below this, we assume the battery can absorb up to AUTO_CHARGE_W and keep PV headroom for it.
# Set ALPHAESS_AUTO_CHARGE_W=0 to disable.
ALPHAESS_AUTO_CHARGE_BELOW_SOC_PCT=90
ALPHAESS_AUTO_CHARGE_W=1500
ALPHAESS_AUTO_CHARGE_MAX_W=3000


# -------------------------
# GoodWe Modbus-TCP
# -------------------------
# Preferred:
GOODWE_HOST=192.168.1.10:502
GOODWE_UNIT=247

# Backwards-compatible aliases (optional):
# GOODWE=192.168.1.10:502
# UNIT=247

# Timeouts/retries (preferred)
MODBUS_TIMEOUT_SEC=3.0
MODBUS_RETRIES=3

# Backwards-compatible aliases (optional):
# TIMEOUT=3.0
# RETRIES=3

# Auto-reconnect on socket errors (Broken pipe, reset, timeout, etc)
MODBUS_RECONNECT_ON_ERROR=1
MODBUS_RECONNECT_MIN_BACKOFF_SEC=1.0
MODBUS_RECONNECT_MAX_BACKOFF_SEC=30.0


# -------------------------
# GoodWe export limiting registers / mode
# -------------------------
# Modes:
#   active_pct -> write % limit directly into GOODWE_ACTIVE_PCT_REG (default 256)
#   pct        -> write % into GOODWE_EXPORT_PCT_REG (292) and %*10 into (293)
GOODWE_EXPORT_LIMIT_MODE=active_pct

# Typical for GW5000 DNS export-limit regs
GOODWE_EXPORT_SWITCH_REG=291
GOODWE_EXPORT_PCT_REG=292
GOODWE_EXPORT_PCT10_REG=293

# Active-power % register used by "active_pct" mode
GOODWE_ACTIVE_PCT_REG=256

# Rated output of inverter (used to show "~xxxxW" estimate)
GOODWE_RATED_W=5000

# If 1: always keep export-limiting "enabled" and just move the % up/down.
# If 0: script will disable limiting when export is allowed (export_costs=False).
GOODWE_ALWAYS_ENABLED=1


# -------------------------
# Runtime telemetry registers (optional; for logging)
# -------------------------
# auto tries dns then mt; "off" disables runtime reads
RUNTIME_PROFILE=auto


# -------------------------
# Control loop tuning
# -------------------------
SLEEP_SECONDS=2

# Rate-limit writes to GoodWe to avoid hammering it
MIN_SECONDS_BETWEEN_WRITES=10.0

# Only write if desired % changes by >= this amount
MIN_PCT_STEP=1

# Simple smoothing (0 = none). Higher = more smoothing.
LIMIT_SMOOTHING=0.2

# Extra console output (including which pymodbus signature was used)
DEBUG=0

